<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout('Cart', ~{::content})}">

<div th:fragment="content">
    <div class="mt-5">
        <div id="cart-empty-state" class="alert alert-info"
             th:classappend="${#lists.isEmpty(items)} ? '' : ' d-none'">
            Your cart is empty. Browse products to add items here.
        </div>

        <div id="cart-table-wrapper"
             th:classappend="${#lists.isEmpty(items)} ? ' d-none' : ''">
            <div class="table-responsive">
                <table id="cart-table" class="table table-striped align-middle">
                    <thead>
                    <tr>
                        <th scope="col">Product</th>
                        <th scope="col">Price</th>
                        <th scope="col" class="text-center">Quantity</th>
                        <th scope="col">Subtotal</th>
                        <th scope="col" class="text-end">Actions</th>
                    </tr>
                    </thead>
                    <tbody id="cart-table-body">
                    <tr th:each="item : ${items}"
                        th:attr="data-product-id=${item.productId}">
                        <td th:text="${item.name}">Product Name</td>
                        <td th:text="${item.price} + ' UAH'">0 UAH</td>
                        <td class="text-center">
                            <div class="input-group input-group-sm justify-content-center">
                                <button type="button" class="btn btn-outline-secondary cart-qty-decrease">-</button>
                                <input type="number"
                                       class="form-control cart-quantity-input text-center mx-1"
                                       min="1"
                                       th:value="${item.quantity}">
                                <button type="button" class="btn btn-outline-secondary cart-qty-increase">+</button>
                            </div>
                        </td>
                        <td class="cart-item-subtotal" th:text="${item.subtotal} + ' UAH'">0 UAH</td>
                        <td class="text-end">
                            <button type="button" class="btn btn-outline-danger btn-sm cart-remove-btn">Remove</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-end gap-4">
                <span class="fw-bold">Items: <span id="cart-total-quantity" th:text="${totalQuantity}">0</span></span>
                <span class="fw-bold">Total: <span id="cart-total-price" th:text="${totalPrice} + ' UAH'">0 UAH</span></span>
            </div>

            <div class="d-flex justify-content-end mt-3">
                <a href="/checkout" class="btn btn-primary">Proceed to checkout</a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const cartCount = document.getElementById('cart-count');
            const cartTableBody = document.getElementById('cart-table-body');
            const cartTotalQuantity = document.getElementById('cart-total-quantity');
            const cartTotalPrice = document.getElementById('cart-total-price');
            const emptyState = document.getElementById('cart-empty-state');
            const tableWrapper = document.getElementById('cart-table-wrapper');

            function notify(type, message) {
                if (typeof window.showToast === 'function') {
                    window.showToast(message, type);
                } else if (type === 'danger') {
                    console.error(message);
                } else {
                    console.log(message);
                }
            }

            function formatCurrency(value) {
                const number = Number(value);
                if (Number.isFinite(number)) {
                    return number.toFixed(2) + ' UAH';
                }
                return value;
            }

            function updateSummary(totalQuantity, totalPrice) {
                if (typeof totalQuantity === 'number') {
                    if (cartTotalQuantity) {
                        cartTotalQuantity.textContent = totalQuantity;
                    }
                    if (cartCount) {
                        cartCount.textContent = totalQuantity;
                    }
                }
                if (totalPrice !== undefined && totalPrice !== null && cartTotalPrice) {
                    cartTotalPrice.textContent = formatCurrency(totalPrice);
                }
            }

            function toggleEmptyState() {
                const hasRows = cartTableBody && cartTableBody.querySelectorAll('tr').length > 0;
                if (emptyState) {
                    emptyState.classList.toggle('d-none', hasRows);
                }
                if (tableWrapper) {
                    tableWrapper.classList.toggle('d-none', !hasRows);
                }
            }

            function performRequest(url, options) {
                return fetch(url, options)
                    .then(function (response) {
                        return response.json()
                            .catch(function () {
                                return {};
                            })
                            .then(function (data) {
                                return {ok: response.ok, data: data};
                            });
                    });
            }

            function handleCartResponse(result, row) {
                if (!result) {
                    notify('danger', 'Unable to update cart');
                    return;
                }
                if (!result.ok) {
                    const message = result.data && result.data.message ? result.data.message : 'Unable to update cart';
                    notify('danger', message);
                    return;
                }

                const data = result.data || {};
                if (data.removed) {
                    if (row) {
                        row.remove();
                    }
                } else if (row) {
                    const quantityInput = row.querySelector('.cart-quantity-input');
                    if (quantityInput && typeof data.quantity === 'number') {
                        quantityInput.value = data.quantity;
                    }
                    const subtotalCell = row.querySelector('.cart-item-subtotal');
                    if (subtotalCell && data.subtotal !== undefined && data.subtotal !== null) {
                        subtotalCell.textContent = formatCurrency(data.subtotal);
                    }
                }

                updateSummary(data.totalQuantity, data.totalPrice);
                notify('success', data.message || 'Cart updated');
                toggleEmptyState();
            }

            function updateQuantity(row, quantity) {
                const productId = row ? row.getAttribute('data-product-id') : null;
                if (!productId) {
                    return;
                }
                performRequest(`/api/cart/items/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({quantity: quantity})
                })
                    .then(function (result) {
                        handleCartResponse(result, row);
                    })
                    .catch(function () {
                        notify('danger', 'Unable to update cart');
                    });
            }

            function removeItem(row) {
                const productId = row ? row.getAttribute('data-product-id') : null;
                if (!productId) {
                    return;
                }
                performRequest(`/api/cart/items/${productId}`, {
                    method: 'DELETE'
                })
                    .then(function (result) {
                        handleCartResponse(result, row);
                    })
                    .catch(function () {
                        notify('danger', 'Unable to update cart');
                    });
            }

            if (cartTableBody) {
                cartTableBody.addEventListener('click', function (event) {
                    const button = event.target.closest('button');
                    if (!button) {
                        return;
                    }

                    const row = button.closest('tr[data-product-id]');
                    if (!row) {
                        return;
                    }

                    if (button.classList.contains('cart-qty-increase')) {
                        const input = row.querySelector('.cart-quantity-input');
                        const current = input ? parseInt(input.value, 10) || 0 : 0;
                        updateQuantity(row, current + 1);
                    } else if (button.classList.contains('cart-qty-decrease')) {
                        const input = row.querySelector('.cart-quantity-input');
                        const current = input ? parseInt(input.value, 10) || 0 : 0;
                        const next = current - 1;
                        updateQuantity(row, next);
                    } else if (button.classList.contains('cart-remove-btn')) {
                        removeItem(row);
                    }
                });

                cartTableBody.addEventListener('change', function (event) {
                    const input = event.target.closest('.cart-quantity-input');
                    if (!input) {
                        return;
                    }
                    const row = input.closest('tr[data-product-id]');
                    if (!row) {
                        return;
                    }
                    const value = parseInt(input.value, 10);
                    if (!Number.isFinite(value)) {
                        input.value = 1;
                        updateQuantity(row, 1);
                        return;
                    }
                    if (value <= 0) {
                        removeItem(row);
                    } else {
                        updateQuantity(row, value);
                    }
                });
            }
        });
    </script>

</div>

</html>
